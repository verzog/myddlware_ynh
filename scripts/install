#!/bin/bash

set -eu

#=================================================
# COMMON VARIABLES AND HELPERS
#=================================================

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME
domain=$YNH_APP_ARG_DOMAIN
path=$YNH_APP_ARG_PATH
init_main_permission=$YNH_APP_ARG_INIT_MAIN_PERMISSION

phpversion="8.4"

#=================================================
# CHECK / PREPARE
#=================================================

ynh_script_progression --message="Checking installation parameters..." --weight=1


# Retrieve system user and install dir created from resources
system_user=$(ynh_app_setting_get --app="$app" --key=system_user || true)
if [ -z "$system_user" ]; then
    system_user="$app"
    ynh_app_setting_set --app="$app" --key=system_user --value="$system_user"
fi

install_dir=$(ynh_app_setting_get --app="$app" --key=install_dir || true)
if [ -z "$install_dir" ]; then
    install_dir="/var/www/$app"
    mkdir -p "$install_dir"
    ynh_app_setting_set --app="$app" --key=install_dir --value="$install_dir"
fi

#=================================================
# INSTALL DEPENDENCIES
#=================================================

ynh_script_progression --message="Installing dependencies..." --weight=2

ynh_install_app_dependencies

#=================================================
# DATABASE SETUP
#=================================================

ynh_script_progression --message="Creating MariaDB database..." --weight=2

db_name="$app"
db_user="$app"
db_pwd="$(ynh_string_random)"

ynh_app_setting_set --app="$app" --key=db_name --value="$db_name"
ynh_app_setting_set --app="$app" --key=db_user --value="$db_user"
ynh_app_setting_set --app="$app" --key=db_pwd --value="$db_pwd"

ynh_mysql_setup_db --db_user="$db_user" --db_name="$db_name" --db_pwd="$db_pwd"

#=================================================
# FETCH AND INSTALL APP SOURCES
#=================================================

ynh_script_progression --message="Installing Myddleware sources..." --weight=3

ynh_setup_source --dest_dir="$install_dir" --source_id="main"

chown -R "$system_user":"$system_user" "$install_dir"

#=================================================
# PHP DEPENDENCIES (COMPOSER)
#=================================================

ynh_script_progression --message="Installing PHP dependencies with Composer..." --weight=3

pushd "$install_dir"

    if ! command -v composer >/dev/null 2>&1; then
        # Try composer.phar if present in the project
        if [ -x "./composer.phar" ]; then
            ln -sf "$install_dir/composer.phar" /usr/local/bin/composer
        else
            ynh_print_err "Composer is not installed and composer.phar not found in sources."
            ynh_die "Composer is required to install Myddleware."
        fi
    fi

    ynh_exec_as "$system_user" composer install --no-dev --optimize-autoloader

popd

#=================================================
# NODE / YARN ASSETS
#=================================================

ynh_script_progression --message="Installing JS dependencies and building assets..." --weight=4

# Ensure a 'yarn' command exists (Debian often ships 'yarnpkg')
if ! command -v yarn >/dev/null 2>&1; then
    if command -v yarnpkg >/dev/null 2>&1; then
        ln -sf "$(command -v yarnpkg)" /usr/local/bin/yarn
    else
        ynh_die "Neither yarn nor yarnpkg was found even though yarnpkg is in apt dependencies."
    fi
fi

pushd "$install_dir"
    # Use lockfile if present
    if [ -f yarn.lock ]; then
        ynh_exec_as "$system_user" yarn install --frozen-lockfile
    else
        ynh_exec_as "$system_user" yarn install
    fi

    ynh_exec_as "$system_user" yarn build
popd

#=================================================
# CREATE .env.local
#=================================================

ynh_script_progression --message="Configuring Myddleware environment..." --weight=2

app_secret="$(ynh_string_random 32)"

cat > "$install_dir/.env.local" <<EOF
# Auto-generated by YunoHost Myddleware installer
APP_ENV=prod
APP_DEBUG=0
APP_SECRET="$app_secret"

DATABASE_URL="mysql://$db_user:$db_pwd@localhost:3306/$db_name"

# Disable email notifications by default.
MAILER_URL="null://localhost"

# Optional: behind YunoHost's reverse proxy
TRUSTED_PROXIES="127.0.0.1,REMOTE_ADDR"
TRUSTED_HOSTS="^$domain$"
EOF

chown "$system_user":"$system_user" "$install_dir/.env.local"
chmod 600 "$install_dir/.env.local"

#=================================================
# NGINX AND PHP-FPM CONFIG
#=================================================

ynh_script_progression --message="Configuring web server (nginx + PHP-FPM $phpversion)..." --weight=3

ynh_add_fpm_config --phpversion="$phpversion"
ynh_add_nginx_config

#=================================================
# PERMISSIONS
#=================================================

ynh_script_progression --message="Configuring permissions..." --weight=1

# 'main' permission has been declared in manifest; just make sure it's set correctly
ynh_permission_update --permission="main" --add="visitors" --url_path="$path" --allowed="visitors"

#=================================================
# RELOAD SERVICES
#=================================================

ynh_script_progression --message="Reloading services..." --weight=1

ynh_systemd_action --service_name="php${phpversion}-fpm" --action=reload
ynh_systemd_action --service_name="nginx" --action=reload

ynh_script_progression --message="Myddleware has been installed successfully." --last
