#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source /usr/share/yunohost/helpers
source "$SCRIPT_DIR/_common.sh"

ynh_abort_if_errors

#=================================================
# CHECKING ARGUMENTS
#=================================================
ynh_script_progression --message="Validating installation parameters" --time --weight=1
ynh_webpath_available --domain="$domain" --path_url="$path_url"
ynh_webpath_register --domain="$domain" --path_url="$path_url" --app="$app"

ynh_app_setting_set --app="$app" --key=domain --value="$domain"
ynh_app_setting_set --app="$app" --key=path --value="$path_url"
ynh_app_setting_set --app="$app" --key=admin --value="$admin_mail"
ynh_app_setting_set --app="$app" --key=is_public --value="$is_public"
ynh_app_setting_set --app="$app" --key=final_path --value="$final_path"
ynh_app_setting_set --app="$app" --key=phpversion --value="$phpversion"

db_pwd=$(ynh_string_random --length=32)
ynh_app_setting_set --app="$app" --key=db_name --value="$db_name"
ynh_app_setting_set --app="$app" --key=db_user --value="$db_user"
ynh_app_setting_set --app="$app" --key=db_pwd --value="$db_pwd"

#=================================================
# SYSTEM USER AND DIRECTORIES
#=================================================
ynh_script_progression --message="Creating system user" --time --weight=1
ynh_system_user_create --username="$app"

ynh_script_progression --message="Preparing installation directory" --time --weight=1
ynh_secure_remove --file="$final_path"
mkdir -p "$final_path"
chown -R "$app:$app" "$final_path"

#=================================================
# FETCH AND PREPARE SOURCES
#=================================================
ynh_script_progression --message="Fetching Myddleware sources" --time --weight=1
ynh_setup_source --dest_dir="$final_path"

#=================================================
# INSTALL COMPOSER DEPENDENCIES
#=================================================
ynh_script_progression --message="Installing Composer" --time --weight=1
ynh_install_composer --phpversion="$phpversion" --workdir="$final_path"

ynh_script_progression --message="Installing PHP dependencies" --time --weight=1
ynh_composer_exec --phpversion="$phpversion" --workdir="$final_path" --commands="install --no-dev --optimize-autoloader"

#=================================================
# DATABASE
#=================================================
ynh_script_progression --message="Creating MariaDB database" --time --weight=1
ynh_mysql_db_create --db_user="$db_user" --db_name="$db_name" --db_pwd="$db_pwd"

#=================================================
# APPLICATION CONFIGURATION
#=================================================
ynh_script_progression --message="Generating application configuration" --time --weight=1
mkdir -p "$final_path/var/cache" "$final_path/var/log"
chown -R "$app:$app" "$final_path/var"

secret=$(openssl rand -hex 32)
cat > "$final_path/.env.local" <<ENV
APP_ENV=prod
APP_SECRET=$secret
DATABASE_URL="mysql://$db_user:$db_pwd@localhost:3306/$db_name"
MAILER_URL=null://localhost
ENV
chown "$app:$app" "$final_path/.env.local"
chmod 640 "$final_path/.env.local"

#=================================================
# PHP-FPM AND NGINX CONFIGURATION
#=================================================
ynh_script_progression --message="Configuring PHP-FPM" --time --weight=1
ynh_add_fpm_config --phpversion="$phpversion" --config="$SCRIPT_DIR/../conf/php-fpm.conf"

ynh_script_progression --message="Configuring NGINX" --time --weight=1
nginx_conf="/etc/nginx/conf.d/$domain.d/$app.conf"
ynh_add_config --template="$SCRIPT_DIR/../conf/nginx.conf" --destination="$nginx_conf"
ynh_replace_string --match_string="__DOMAIN__" --replace_string="$domain" --target_file="$nginx_conf"
ynh_replace_string --match_string="__PATH__" --replace_string="$path_url" --target_file="$nginx_conf"
ynh_replace_string --match_string="__FINALPATH__" --replace_string="$final_path" --target_file="$nginx_conf"
ynh_replace_string --match_string="__PHPVERSION__" --replace_string="$phpversion" --target_file="$nginx_conf"
ynh_replace_string --match_string="__APP__" --replace_string="$app" --target_file="$nginx_conf"

#=================================================
# PERMISSIONS
#=================================================
ynh_script_progression --message="Applying permissions" --time --weight=1
if [ "$is_public" = "1" ] || [ "$is_public" = "true" ]; then
    ynh_permission_update --permission=main --add=visitors
fi

#=================================================
# SERVICE RELOAD
#=================================================
ynh_script_progression --message="Reloading services" --time --weight=1
ynh_systemd_action --service_name="php${phpversion}-fpm" --action="reload" --log_path="/var/log/php${phpversion}-fpm/$app.log" || true
ynh_systemd_action --service_name="nginx" --action="reload" || true

ynh_script_success
