#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

SOURCE_DIR="$(cd -- "$(dirname "$0")" && pwd)"
source "$SOURCE_DIR/_common.sh"
source /usr/share/yunohost/helpers

# Exit on command errors
ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS
#=================================================

app=$YNH_APP_INSTANCE_NAME

#=================================================
# REMOVE DATABASE
#=================================================

# Load DB settings if they were saved
db_name=$(ynh_app_setting_get --app="$app" --key=db_name)
db_user=$(ynh_app_setting_get --app="$app" --key=db_user)

if [ -n "$db_name" ]; then
    ynh_script_progression "Removing database..."
    # Drop the database and the user
    ynh_mysql_remove_db --db_user="$db_user" --db_name="$db_name"
fi

#=================================================
# REMOVE PHP-FPM CONFIGURATION
#=================================================

# The manifest removes the files, but we should reload the service
ynh_script_progression "Reloading PHP-FPM..."
systemctl reload "php$YNH_PHP_VERSION-fpm"

#=================================================
# REMOVE NGINX CONFIGURATION
#=================================================

# The manifest removes the config file, but we must reload Nginx
ynh_script_progression "Reloading NGINX..."
systemctl reload nginx
